<style>
  .new-arrivals-section {
    background-color: {{ section.settings.background_color }} !important;
    padding-top: {{ section.settings.padding_top }}px;
    padding-bottom: {{ section.settings.padding_bottom }}px;
    position: relative;
    overflow: hidden;
    border-radius: {{ section.settings.section_border_radius }}px;
  }

  .new-arrivals-container {
    max-width: 1200px;
    margin: 0 auto;
    position: relative;
    z-index: 2;
  }

  /* Static Decorative Icon - Fixed Proportional Scaling */
  .floating-clock {
    position: absolute;
    top: {{ section.settings.icon_top_desktop }}%;
    left: {{ section.settings.icon_left_desktop }}%;
    width: {{ section.settings.icon_size_desktop }}px;
    height: {{ section.settings.icon_size_desktop }}px;
    object-fit: contain;
    z-index: 1;
    /* Removed all animations - now static */
  }

  /* Header Section */
  .new-arrivals-header {
    text-align: center;
    margin-bottom: 3rem;
    padding: 0 2rem;
  }

  .new-arrivals-title {
    font-size: {{ section.settings.title_size }}px;
    font-weight: bold;
    color: {{ section.settings.title_color }} !important;
    margin: 0;
    line-height: 1.2;
    position: relative;
    display: inline-block;
    width: 100%;
  }

  /* Curvy line decoration under heading */
  .new-arrivals-title::after {
    content: '';
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    bottom: -{{ section.settings.line_icon_overlap }}px;
    width: {{ section.settings.line_icon_width }}px;
    height: {{ section.settings.line_icon_height }}px;
    background-image: url("{{ section.settings.line_icon | image_url }}");
    background-repeat: no-repeat;
    background-size: contain;
    background-position: center;
    z-index: 1;
  }

  .new-arrivals-title-wrapper {
    margin-bottom: {{ section.settings.line_icon_spacing }}px;
  }

  .new-arrivals-description {
    font-size: {{ section.settings.description_size }}px;
    color: {{ section.settings.text_color }} !important;
    line-height: 1.6;
    max-width: 600px;
    margin: 0 auto 2rem;
  }

  .new-arrivals-description p {
    color: {{ section.settings.text_color }} !important;
    margin: 0;
  }

  /* Navigation Arrows */
  .new-arrivals-navigation {
    display: flex;
    justify-content: center;
    gap: 1rem;
    margin-bottom: 2rem;
  }

  .new-arrivals-nav-btn {
    width: 40px;
    height: 40px;
    border: 2px solid {{ section.settings.nav_button_color }};
    background-color: transparent;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    color: {{ section.settings.nav_button_color }};
  }

  .new-arrivals-nav-btn:hover {
    background-color: {{ section.settings.nav_button_color }};
    color: white;
    transform: scale(1.1);
  }

  .new-arrivals-nav-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
  }

  .new-arrivals-viewport {
    overflow: hidden;
    width: 100%;
    padding: 0 2rem;
  }

  /* Products Grid */
  .new-arrivals-grid {
    display: flex;
    gap: 20px;
    margin-bottom: 3rem;
    transition: transform 0.5s ease;
    cursor: grab;
  }

  .new-arrivals-grid:active {
    cursor: grabbing;
  }

  .new-arrivals-grid.dragging {
    transition: none;
  }

  /* Product Cards */
  .new-arrivals-card {
    flex: 0 0 280px;
    width: 280px;
    background-color: white;
    border-radius: 20px;
    border: 3px solid #F4A261;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    height: {{ section.settings.card_height }}px;
    transition: transform 0.3s ease;
    text-decoration: none;
    color: inherit;
    display: block;
  }

  .new-arrivals-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    text-decoration: none;
    color: inherit;
  }

  .new-arrivals-image-wrapper {
    position: relative;
    overflow: hidden;
    width: 100%;
    height: calc({{ section.settings.card_height }}px - {{ section.settings.card_info_height }}px);
  }

  .new-arrivals-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
    transition: transform 0.3s ease;
  }

  .new-arrivals-card:hover .new-arrivals-image {
    transform: scale(1.05);
  }

  .new-arrivals-info {
    padding: 1rem 1.5rem;
    text-align: left;
    height: {{ section.settings.card_info_height }}px;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    align-items: flex-start;
    gap: 0.5rem;
  }

  .new-arrivals-product-title {
    font-size: {{ section.settings.product_title_size }}px;
    font-weight: 600;
    color: {{ section.settings.product_title_color }} !important;
    margin: 0;
    line-height: 1.2;
    text-align: left;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
    word-break: break-word;
    hyphens: auto;
  }

  .new-arrivals-product-price {
    font-size: {{ section.settings.product_price_size }}px;
    color: {{ section.settings.product_price_color }} !important;
    font-weight: 500;
    line-height: 1.4;
    text-align: left;
    margin: 0;
    white-space: nowrap;
  }

  .new-arrivals-compare-price {
    text-decoration: line-through;
    color: {{ section.settings.product_compare_price_color }} !important;
    margin-right: 0.5rem;
    font-weight: 400;
  }

  /* Mobile Responsive */
  @media screen and (max-width: 768px) {
    .new-arrivals-section {
      padding-top: {{ section.settings.padding_top_mobile }}px;
      padding-bottom: {{ section.settings.padding_bottom_mobile }}px;
    }

    .new-arrivals-container {
      padding: 0 1rem;
    }

    .new-arrivals-header {
      margin-bottom: 2rem;
    }

    .new-arrivals-title {
      font-size: {{ section.settings.title_size | times: 0.8 }}px;
    }

    /* Responsive curvy line on mobile */
    .new-arrivals-title::after {
      width: {{ section.settings.line_icon_width | times: 0.8 }}px;
      height: {{ section.settings.line_icon_height | times: 0.8 }}px;
      bottom: -{{ section.settings.line_icon_overlap | times: 0.8 }}px;
    }

    .new-arrivals-title-wrapper {
      margin-bottom: {{ section.settings.line_icon_spacing | times: 0.7 }}px;
    }

    .new-arrivals-description {
      font-size: {{ section.settings.description_size | times: 0.9 }}px;
    }

    .new-arrivals-grid {
      gap: 16px;
    }

    .new-arrivals-card {
      flex: 0 0 260px;
      width: 260px;
      height: {{ section.settings.card_height | times: 0.9 }}px;
    }

    .new-arrivals-image-wrapper {
      height: calc({{ section.settings.card_height | times: 0.9 }}px - {{ section.settings.card_info_height | times: 0.9 }}px);
    }

    .new-arrivals-info {
      height: {{ section.settings.card_info_height | times: 0.9 }}px;
      padding: 0.75rem 1rem;
      gap: 0.25rem;
    }

    .new-arrivals-product-title {
      font-size: {{ section.settings.product_title_size | times: 0.9 }}px;
    }

    .new-arrivals-product-price {
      font-size: {{ section.settings.product_price_size | times: 0.9 }}px;
    }

    /* Mobile Icon Position - Fixed Proportional Scaling */
    .floating-clock {
      top: {{ section.settings.icon_top_mobile }}% !important;
      left: {{ section.settings.icon_left_mobile }}% !important;
      width: {{ section.settings.icon_size_mobile }}px !important;
      height: {{ section.settings.icon_size_mobile }}px !important;
    }
  }

  /* Tablet */
  @media screen and (min-width: 769px) and (max-width: 1024px) {
    .new-arrivals-card {
      flex: 0 0 270px;
      width: 270px;
    }
  }
</style>

<section class="new-arrivals-section">
  {% comment %} Static Decorative Icon {% endcomment %}
  {% if section.settings.floating_icon != blank %}
    <img
      src="{{ section.settings.floating_icon | image_url: width: 120 }}"
      alt="Decorative icon"
      class="floating-clock"
      loading="lazy"
    >
  {% endif %}

  <div class="new-arrivals-container">
    {% comment %} Section Header {% endcomment %}
    <div class="new-arrivals-header">
      {% if section.settings.title != blank %}
        <div class="new-arrivals-title-wrapper">
          <h2 class="new-arrivals-title">{{ section.settings.title | escape }}</h2>
        </div>
      {% endif %}

      {% if section.settings.description != blank %}
        <div class="new-arrivals-description">{{ section.settings.description }}</div>
      {% endif %}

      {% comment %} Slider Navigation {% endcomment %}
      <div class="new-arrivals-navigation">
        <button class="new-arrivals-nav-btn new-arrivals-prev" aria-label="Previous products">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
            <path d="M10 2L4 8l6 6" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
        <button class="new-arrivals-nav-btn new-arrivals-next" aria-label="Next products">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
            <path d="M6 2l6 6-6 6" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>
    </div>

    {% comment %} Products Container {% endcomment %}
    <div class="new-arrivals-viewport">
      <div class="new-arrivals-grid" id="newArrivalsGrid">
        {% assign collection = collections[section.settings.collection] %}
        {% if collection != blank %}
          {% for product in collection.products limit: section.settings.products_to_show %}
            <a href="{{ product.url }}" class="new-arrivals-card">
              <div class="new-arrivals-image-wrapper">
                {% if product.featured_image != blank %}
                  <img
                    src="{{ product.featured_image | image_url: width: 600 }}"
                    alt="{{ product.featured_image.alt | default: product.title }}"
                    class="new-arrivals-image"
                    loading="lazy"
                    width="600"
                    height="750"
                  >
                {% else %}
                  <div
                    class="new-arrivals-image"
                    style="background-color: #f5f5f5; display: flex; align-items: center; justify-content: center; color: #999;"
                  >
                    No Image
                  </div>
                {% endif %}
              </div>

              <div class="new-arrivals-info">
                <h3 class="new-arrivals-product-title">{{ product.title | escape }}</h3>
                <div class="new-arrivals-product-price">
                  {% if product.compare_at_price > product.price %}
                    <span class="new-arrivals-compare-price">{{ product.compare_at_price | money }}</span>
                  {% endif %}
                  <span>{{ product.price | money }}</span>
                </div>
              </div>
            </a>
          {% endfor %}
        {% else %}
          {% comment %} Placeholder when no collection is selected {% endcomment %}
          {% for i in (1..4) %}
            <div class="new-arrivals-card">
              <div class="new-arrivals-image-wrapper">
                <div
                  class="new-arrivals-image"
                  style="background-color: #f5f5f5; display: flex; align-items: center; justify-content: center; color: #999;"
                >
                  Select Collection
                </div>
              </div>
              <div class="new-arrivals-info">
                <h3 class="new-arrivals-product-title">Product Title</h3>
                <div class="new-arrivals-product-price">Rs. 3,100.00</div>
              </div>
            </div>
          {% endfor %}
        {% endif %}
      </div>
    </div>
  </div>
</section>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const grid = document.getElementById('newArrivalsGrid');
    const prevBtn = document.querySelector('.new-arrivals-prev');
    const nextBtn = document.querySelector('.new-arrivals-next');
    const cards = grid.querySelectorAll('.new-arrivals-card');
    const viewport = grid.parentElement;

    if (!grid || !prevBtn || !nextBtn || cards.length === 0) return;

    let currentIndex = 0;
    let isDragging = false;
    let startX = 0;
    let currentTranslateX = 0;
    let dragStartX = 0;

    function updateCarousel(animate = true) {
      if (animate && !isDragging) {
        grid.style.transition = 'transform 0.5s ease';
      } else {
        grid.style.transition = 'none';
      }

      const cardWidth = cards[0].offsetWidth;
      const gap = parseInt(window.getComputedStyle(grid).gap);
      const totalCardSpace = cardWidth + gap;
      
      // Manually calculate total width for precision
      const totalGridWidth = (cards.length * cardWidth) + ((cards.length - 1) * gap);
      const maxTranslate = Math.max(0, totalGridWidth - viewport.clientWidth);

      // Calculate the current translation and clamp it
      let translateX = -(currentIndex * totalCardSpace) + currentTranslateX;
      translateX = Math.max(-maxTranslate, Math.min(0, translateX));

      grid.style.transform = `translateX(${translateX}px)`;

      // Update button states
      prevBtn.disabled = translateX >= 0;
      nextBtn.disabled = translateX <= -maxTranslate;
    }

    function goNext() {
      const cardWidth = cards[0].offsetWidth;
      const gap = parseInt(window.getComputedStyle(grid).gap);
      const totalCardSpace = cardWidth + gap;
      const totalGridWidth = (cards.length * cardWidth) + ((cards.length - 1) * gap);
      const maxTranslate = Math.max(0, totalGridWidth - viewport.clientWidth);
      const currentTranslate = Math.abs(parseFloat(grid.style.transform.replace('translateX(', '').replace('px)', '')) || 0);

      if (currentTranslate < maxTranslate) {
        currentIndex++;
        updateCarousel();
      }
    }

    function goPrev() {
      if (currentIndex > 0) {
        currentIndex--;
        updateCarousel();
      }
    }

    function handleDragStart(clientX) {
      isDragging = true;
      dragStartX = clientX;
      grid.classList.add('dragging');
      // Store the initial transform value
      startX = parseFloat(grid.style.transform.replace('translateX(', '').replace('px)', '')) || 0;
    }

    function handleDragMove(clientX) {
      if (!isDragging) return;
      const deltaX = clientX - dragStartX;
      currentTranslateX = deltaX;
      
      const cardWidth = cards[0].offsetWidth;
      const gap = parseInt(window.getComputedStyle(grid).gap);
      const totalCardSpace = cardWidth + gap;
      const totalGridWidth = (cards.length * cardWidth) + ((cards.length - 1) * gap);
      const maxTranslate = Math.max(0, totalGridWidth - viewport.clientWidth);
      
      let newTranslate = startX + deltaX;
      // Add "elastic" resistance at the boundaries
      if (newTranslate > 0) {
        newTranslate = Math.sqrt(newTranslate) * 5;
      } else if (newTranslate < -maxTranslate) {
        newTranslate = -maxTranslate - Math.sqrt(Math.abs(newTranslate + maxTranslate)) * 5;
      }
      
      grid.style.transform = `translateX(${newTranslate}px)`;
    }

    function handleDragEnd(clientX) {
      if (!isDragging) return;
      isDragging = false;
      grid.classList.remove('dragging');

      const deltaX = clientX - dragStartX;
      const cardWidth = cards[0].offsetWidth;
      const gap = parseInt(window.getComputedStyle(grid).gap);
      const totalCardSpace = cardWidth + gap;

      // Snap to the nearest card
      const movedBy = Math.round(deltaX / totalCardSpace);
      currentIndex = Math.max(0, Math.min(cards.length - 1, currentIndex - movedBy));
      
      currentTranslateX = 0;
      updateCarousel();
    }

    // Mouse events
    grid.addEventListener('mousedown', (e) => { e.preventDefault(); handleDragStart(e.clientX); });
    document.addEventListener('mousemove', (e) => { if (isDragging) handleDragMove(e.clientX); });
    document.addEventListener('mouseup', (e) => { if (isDragging) handleDragEnd(e.clientX); });
    grid.addEventListener('mouseleave', (e) => { if (isDragging) handleDragEnd(e.clientX); });

    // Touch events
    grid.addEventListener('touchstart', (e) => handleDragStart(e.touches[0].clientX));
    grid.addEventListener('touchmove', (e) => handleDragMove(e.touches[0].clientX));
    grid.addEventListener('touchend', (e) => handleDragEnd(e.changedTouches[0].clientX));

    // Button events
    prevBtn.addEventListener('click', goPrev);
    nextBtn.addEventListener('click', goNext);

    // Initial setup
    setTimeout(updateCarousel, 100);
    window.addEventListener('resize', () => setTimeout(updateCarousel, 100));
  });
</script>

{% schema %}
{
  "name": "New Arrivals Collection",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "header",
      "content": "Section Padding"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 200,
      "step": 10,
      "unit": "px",
      "label": "Desktop Padding Top",
      "default": 60
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 200,
      "step": 10,
      "unit": "px",
      "label": "Desktop Padding Bottom",
      "default": 60
    },
    {
      "type": "range",
      "id": "padding_top_mobile",
      "min": 0,
      "max": 150,
      "step": 5,
      "unit": "px",
      "label": "Mobile Padding Top",
      "default": 40
    },
    {
      "type": "range",
      "id": "padding_bottom_mobile",
      "min": 0,
      "max": 150,
      "step": 5,
      "unit": "px",
      "label": "Mobile Padding Bottom",
      "default": 40
    },
    {
      "type": "header",
      "content": "Decorative Line Icon"
    },
    {
      "type": "image_picker",
      "id": "line_icon",
      "label": "Curvy Line Icon (SVG/PNG)",
      "info": "Upload your custom curvy line icon to appear below the heading"
    },
    {
      "type": "range",
      "id": "line_icon_width",
      "min": 40,
      "max": 200,
      "step": 5,
      "unit": "px",
      "label": "Line Icon Width",
      "default": 80
    },
    {
      "type": "range",
      "id": "line_icon_height",
      "min": 8,
      "max": 50,
      "step": 2,
      "unit": "px",
      "label": "Line Icon Height",
      "default": 12
    },
    {
      "type": "range",
      "id": "line_icon_overlap",
      "min": 0,
      "max": 20,
      "step": 2,
      "unit": "px",
      "label": "Overlap with Heading",
      "default": 8
    },
    {
      "type": "range",
      "id": "line_icon_spacing",
      "min": 5,
      "max": 40,
      "step": 5,
      "unit": "px",
      "label": "Spacing Below Icon",
      "default": 15
    },
    {
      "type": "header",
      "content": "Collection Settings"
    },
    {
      "type": "collection",
      "id": "collection",
      "label": "Collection",
      "info": "Select the collection to display products from"
    },
    {
      "type": "range",
      "id": "products_to_show",
      "min": 4,
      "max": 20,
      "step": 1,
      "label": "Number of products to show",
      "default": 12
    },
    {
      "type": "header",
      "content": "Section Settings"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background Color",
      "default": "#F4A261"
    },
    {
      "type": "range",
      "id": "section_border_radius",
      "min": 0,
      "max": 50,
      "step": 2,
      "unit": "px",
      "label": "Section Corner Roundness",
      "default": 20
    },
    {
      "type": "header",
      "content": "Card Dimensions"
    },
    {
      "type": "range",
      "id": "card_height",
      "min": 300,
      "max": 500,
      "step": 10,
      "unit": "px",
      "label": "Product Card Height",
      "default": 400,
      "info": "Total height of each product card"
    },
    {
      "type": "range",
      "id": "card_info_height",
      "min": 80,
      "max": 160,
      "step": 10,
      "unit": "px",
      "label": "Product Info Section Height",
      "default": 120,
      "info": "Height of the title and price area at bottom of card"
    },
    {
      "type": "header",
      "content": "Decorative Icon - Desktop"
    },
    {
      "type": "image_picker",
      "id": "floating_icon",
      "label": "Decorative Icon (PNG recommended)"
    },
    {
      "type": "range",
      "id": "icon_size_desktop",
      "min": 30,
      "max": 150,
      "step": 5,
      "unit": "px",
      "label": "Desktop Icon Size",
      "default": 60
    },
    {
      "type": "range",
      "id": "icon_top_desktop",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "%",
      "label": "Desktop Top Position",
      "default": 15
    },
    {
      "type": "range",
      "id": "icon_left_desktop",
      "min": 0,
      "max": 50,
      "step": 1,
      "unit": "%",
      "label": "Desktop Left Position",
      "default": 8
    },
    {
      "type": "header",
      "content": "Decorative Icon - Mobile"
    },
    {
      "type": "range",
      "id": "icon_size_mobile",
      "min": 20,
      "max": 100,
      "step": 5,
      "unit": "px",
      "label": "Mobile Icon Size",
      "default": 45
    },
    {
      "type": "range",
      "id": "icon_top_mobile",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "%",
      "label": "Mobile Top Position",
      "default": 10
    },
    {
      "type": "range",
      "id": "icon_left_mobile",
      "min": 0,
      "max": 50,
      "step": 1,
      "unit": "%",
      "label": "Mobile Left Position",
      "default": 5
    },
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Section Title",
      "default": "New Arrivals – Summer PJs Are Here!"
    },
    {
      "type": "richtext",
      "id": "description",
      "label": "Description",
      "default": "<p>Choosing the right clothes and toys for our little ones goes beyond style. It's about nurturing their growth and sparking their imagination.</p>"
    },
    {
      "type": "header",
      "content": "Text Sizes"
    },
    {
      "type": "range",
      "id": "title_size",
      "min": 24,
      "max": 48,
      "step": 2,
      "unit": "px",
      "label": "Title Font Size",
      "default": 32
    },
    {
      "type": "range",
      "id": "description_size",
      "min": 14,
      "max": 20,
      "step": 1,
      "unit": "px",
      "label": "Description Font Size",
      "default": 16
    },
    {
      "type": "range",
      "id": "product_title_size",
      "min": 14,
      "max": 24,
      "step": 1,
      "unit": "px",
      "label": "Product Title Font Size",
      "default": 16
    },
    {
      "type": "range",
      "id": "product_price_size",
      "min": 12,
      "max": 20,
      "step": 1,
      "unit": "px",
      "label": "Product Price Font Size",
      "default": 16
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color",
      "id": "title_color",
      "label": "Title Color",
      "default": "#8B4513"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text Color",
      "default": "#5D4037"
    },
    {
      "type": "color",
      "id": "product_title_color",
      "label": "Product Title Color",
      "default": "#8B4513"
    },
    {
      "type": "color",
      "id": "product_price_color",
      "label": "Product Price Color",
      "default": "#F4A261"
    },
    {
      "type": "color",
      "id": "product_compare_price_color",
      "label": "Product Compare Price Color",
      "default": "#999999"
    },
    {
      "type": "color",
      "id": "nav_button_color",
      "label": "Navigation Button Color",
      "default": "#8B4513"
    }
  ],
  "presets": [
    {
      "name": "New Arrivals Collection",
      "settings": {
        "title": "New Arrivals – Summer PJs Are Here!",
        "description": "<p>Choosing the right clothes and toys for our little ones goes beyond style. It's about nurturing their growth and sparking their imagination.</p>",
        "products_to_show": 12,
        "padding_top": 60,
        "padding_bottom": 60,
        "padding_top_mobile": 40,
        "padding_bottom_mobile": 40
      }
    }
  ]
}
{% endschema %}
